var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,i=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,a=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&i(e,n,t[n]);if(r)for(var n of r(t))s.call(t,n)&&i(e,n,t[n]);return e},c=(e,r)=>t(e,n(r)),u=(e,t,n)=>new Promise(((r,o)=>{var s=e=>{try{a(n.next(e))}catch(t){o(t)}},i=e=>{try{a(n.throw(e))}catch(t){o(t)}},a=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,i);a((n=n.apply(e,t)).next())})),d=function(e,t){this[0]=e,this[1]=t},l=(e,t,n)=>{var r,o,s=(e,t,r,o)=>{try{var i=n[e](t),a=(t=i.value)instanceof d,c=i.done;Promise.resolve(a?t[0]:t).then((n=>a?s("return"===e?e:"next",t[1]?{done:n.done,value:n.value}:n,r,o):r({value:n,done:c}))).catch((e=>s("throw",e,r,o)))}catch(u){o(u)}},i=e=>a[e]=t=>new Promise(((n,r)=>s(e,t,n,r))),a={};return n=n.apply(e,t),a[(r="asyncIterator",(o=Symbol[r])?o:Symbol.for("Symbol."+r))]=()=>a,i("next"),i("throw"),i("return"),a};import{S as f,G as p}from"./index-Nu7650xe.js";const v=(e,t)=>t.some((t=>e instanceof t));let y,h;const b=new WeakMap,m=new WeakMap,g=new WeakMap;let w={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return b.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return S(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function I(e){w=e(w)}function D(e){return(h||(h=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(x(this),t),S(this.request)}:function(...t){return S(e.apply(x(this),t))}}function B(e){return"function"==typeof e?D(e):(e instanceof IDBTransaction&&function(e){if(b.has(e))return;const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)}));b.set(e,t)}(e),v(e,y||(y=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,w):e)}function S(e){if(e instanceof IDBRequest)return function(e){const t=new Promise(((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{t(S(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",s)}));return g.set(t,e),t}(e);if(m.has(e))return m.get(e);const t=B(e);return t!==e&&(m.set(e,t),g.set(t,e)),t}const x=e=>g.get(e);const E=["get","getKey","getAll","getAllKeys","count"],j=["put","add","delete","clear"],O=new Map;function P(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(O.get(t))return O.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=j.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!E.includes(n))return;const s=function(e,...t){return u(this,null,(function*(){const s=this.transaction(e,o?"readwrite":"readonly");let i=s.store;return r&&(i=i.index(t.shift())),(yield Promise.all([i[n](...t),o&&s.done]))[0]}))};return O.set(t,s),s}I((e=>c(a({},e),{get:(t,n,r)=>P(t,n)||e.get(t,n,r),has:(t,n)=>!!P(t,n)||e.has(t,n)})));const L=["continue","continuePrimaryKey","advance"],k={},H=new WeakMap,M=new WeakMap,C={get(e,t){if(!L.includes(t))return e[t];let n=k[t];return n||(n=k[t]=function(...e){H.set(this,M.get(this)[t](...e))}),n}};function A(...e){return l(this,null,(function*(){let t=this;if(t instanceof IDBCursor||(t=yield new d(t.openCursor(...e))),!t)return;const n=new Proxy(t,C);for(M.set(n,t),g.set(n,x(t));t;)yield n,t=yield new d(H.get(n)||t.continue()),H.delete(n)}))}function V(e,t){return t===Symbol.asyncIterator&&v(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&v(e,[IDBIndex,IDBObjectStore])}I((e=>c(a({},e),{get:(t,n,r)=>V(t,n)?A:e.get(t,n,r),has:(t,n)=>V(t,n)||e.has(t,n)})));const W="dragon-isle-db",K=1;let N=null;function T(){return u(this,null,(function*(){return N||(N=yield function(e,t,{blocked:n,upgrade:r,blocking:o,terminated:s}={}){const i=indexedDB.open(e,t),a=S(i);return r&&i.addEventListener("upgradeneeded",(e=>{r(S(i.result),e.oldVersion,e.newVersion,S(i.transaction),e)})),n&&i.addEventListener("blocked",(e=>n(e.oldVersion,e.newVersion,e))),a.then((e=>{s&&e.addEventListener("close",(()=>s())),o&&e.addEventListener("versionchange",(e=>o(e.oldVersion,e.newVersion,e)))})).catch((()=>{})),a}(W,K,{upgrade(e){if(!e.objectStoreNames.contains("saves")){e.createObjectStore("saves",{keyPath:"saveHeader.slotId"}).createIndex("by-updated","saveHeader.updatedAt")}e.objectStoreNames.contains("settings")||e.createObjectStore("settings")}})),N}))}function q(e){return u(this,null,(function*(){try{const t=yield T();e.saveHeader.updatedAt=(new Date).toISOString(),e.saveHeader.version=f;const n=p.parse(e);yield t.put("saves",n)}catch(t){throw new Error("Failed to save game")}}))}function F(e){return u(this,null,(function*(){try{const t=yield T(),n=yield t.get("saves",e);if(!n)return null;const r=p.parse(n);if(r.saveHeader.version!==f){return yield function(e){return u(this,null,(function*(){let t=a({},e);return"historyIndex"in t.worldSnapshot||(t=c(a({},t),{worldSnapshot:c(a({},t.worldSnapshot),{historyIndex:{poiState:[],factionBaseline:{relations:{},notes:[]},mapMarkers:[],questHooks:[]}})})),t.saveHeader=c(a({},t.saveHeader),{version:f}),t}))}(r)}return r}catch(t){throw new Error("Failed to load game")}}))}function G(e){return u(this,null,(function*(){try{const t=yield T(),n=yield t.get("saves",e);return n?{exists:!0,header:n.saveHeader}:{exists:!1}}catch(t){return{exists:!1}}}))}export{G as getSaveInfo,F as loadGameFromSlot,q as saveGameToSlot};
//# sourceMappingURL=saveManager-BcucB9PP.js.map
