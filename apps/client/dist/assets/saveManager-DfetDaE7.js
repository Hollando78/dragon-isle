var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,a=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,i=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&a(e,n,t[n]);if(r)for(var n of r(t))s.call(t,n)&&a(e,n,t[n]);return e},c=(e,r)=>t(e,n(r)),u=(e,t,n)=>new Promise((r,o)=>{var s=e=>{try{i(n.next(e))}catch(t){o(t)}},a=e=>{try{i(n.throw(e))}catch(t){o(t)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,a);i((n=n.apply(e,t)).next())}),d=function(e,t){this[0]=e,this[1]=t},l=(e,t,n)=>{var r,o,s=(e,t,r,o)=>{try{var a=n[e](t),i=(t=a.value)instanceof d,c=a.done;Promise.resolve(i?t[0]:t).then(n=>i?s("return"===e?e:"next",t[1]?{done:n.done,value:n.value}:n,r,o):r({value:n,done:c})).catch(e=>s("throw",e,r,o))}catch(u){o(u)}},a=e=>i[e]=t=>new Promise((n,r)=>s(e,t,n,r)),i={};return n=n.apply(e,t),i[(r="asyncIterator",(o=Symbol[r])?o:Symbol.for("Symbol."+r))]=()=>i,a("next"),a("throw"),a("return"),i};import{S as f,G as p}from"./index-DW090VGp.js";const v=(e,t)=>t.some(t=>e instanceof t);let y,h;const b=new WeakMap,m=new WeakMap,w=new WeakMap;let I={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return b.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return S(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function g(e){I=e(I)}function D(e){return(h||(h=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(E(this),t),S(this.request)}:function(...t){return S(e.apply(E(this),t))}}function B(e){return"function"==typeof e?D(e):(e instanceof IDBTransaction&&function(e){if(b.has(e))return;const t=new Promise((t,n)=>{const r=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",s),e.removeEventListener("abort",s)},o=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",o),e.addEventListener("error",s),e.addEventListener("abort",s)});b.set(e,t)}(e),v(e,y||(y=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,I):e)}function S(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,n)=>{const r=()=>{e.removeEventListener("success",o),e.removeEventListener("error",s)},o=()=>{t(S(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",o),e.addEventListener("error",s)});return w.set(t,e),t}(e);if(m.has(e))return m.get(e);const t=B(e);return t!==e&&(m.set(e,t),w.set(t,e)),t}const E=e=>w.get(e);const x=["get","getKey","getAll","getAllKeys","count"],j=["put","add","delete","clear"],O=new Map;function P(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(O.get(t))return O.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,o=j.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!o&&!x.includes(n))return;const s=function(e,...t){return u(this,null,function*(){const s=this.transaction(e,o?"readwrite":"readonly");let a=s.store;return r&&(a=a.index(t.shift())),(yield Promise.all([a[n](...t),o&&s.done]))[0]})};return O.set(t,s),s}g(e=>c(i({},e),{get:(t,n,r)=>P(t,n)||e.get(t,n,r),has:(t,n)=>!!P(t,n)||e.has(t,n)}));const L=["continue","continuePrimaryKey","advance"],k={},H=new WeakMap,M=new WeakMap,C={get(e,t){if(!L.includes(t))return e[t];let n=k[t];return n||(n=k[t]=function(...e){H.set(this,M.get(this)[t](...e))}),n}};function A(...e){return l(this,null,function*(){let t=this;if(t instanceof IDBCursor||(t=yield new d(t.openCursor(...e))),!t)return;const n=new Proxy(t,C);for(M.set(n,t),w.set(n,E(t));t;)yield n,t=yield new d(H.get(n)||t.continue()),H.delete(n)})}function V(e,t){return t===Symbol.asyncIterator&&v(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&v(e,[IDBIndex,IDBObjectStore])}g(e=>c(i({},e),{get:(t,n,r)=>V(t,n)?A:e.get(t,n,r),has:(t,n)=>V(t,n)||e.has(t,n)}));let W=null;function K(){return u(this,null,function*(){return W||(W=yield function(e,t,{blocked:n,upgrade:r,blocking:o,terminated:s}={}){const a=indexedDB.open(e,t),i=S(a);return r&&a.addEventListener("upgradeneeded",e=>{r(S(a.result),e.oldVersion,e.newVersion,S(a.transaction),e)}),n&&a.addEventListener("blocked",e=>n(e.oldVersion,e.newVersion,e)),i.then(e=>{s&&e.addEventListener("close",()=>s()),o&&e.addEventListener("versionchange",e=>o(e.oldVersion,e.newVersion,e))}).catch(()=>{}),i}("dragon-isle-db",1,{upgrade(e){if(!e.objectStoreNames.contains("saves")){e.createObjectStore("saves",{keyPath:"saveHeader.slotId"}).createIndex("by-updated","saveHeader.updatedAt")}e.objectStoreNames.contains("settings")||e.createObjectStore("settings")}})),W})}function N(e){return u(this,null,function*(){try{const t=yield K();e.saveHeader.updatedAt=(new Date).toISOString(),e.saveHeader.version=f;const n=p.parse(e);yield t.put("saves",n)}catch(t){throw new Error("Failed to save game")}})}function T(e){return u(this,null,function*(){try{const t=yield K(),n=yield t.get("saves",e);if(!n)return null;const r=p.parse(n);if(r.saveHeader.version!==f){return yield function(e){return u(this,null,function*(){let t=i({},e);return"historyIndex"in t.worldSnapshot||(t=c(i({},t),{worldSnapshot:c(i({},t.worldSnapshot),{historyIndex:{poiState:[],factionBaseline:{relations:{},notes:[]},mapMarkers:[],questHooks:[]}})})),t.saveHeader=c(i({},t.saveHeader),{version:f}),t})}(r)}return r}catch(t){throw new Error("Failed to load game")}})}export{T as loadGameFromSlot,N as saveGameToSlot};
//# sourceMappingURL=saveManager-DfetDaE7.js.map
